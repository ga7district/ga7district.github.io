<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Local Events Aggregator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --card:#141a32; --muted:#8fa0c9; --text:#e8edff; --accent:#5aa9ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text);}
    header { padding:24px 16px; border-bottom:1px solid #223; position:sticky; top:0; background:linear-gradient(180deg, #0b1020 0%, #0b1020dd 70%, #0b102000 100%); backdrop-filter:saturate(140%) blur(6px); z-index:10;}
    .container { max-width:1100px; margin:0 auto; padding: 0 8px;}
    h1 { margin:0 0 8px; font-size:22px; }
    .controls { display:grid; gap:8px; grid-template-columns: 1.3fr 0.9fr 0.9fr 0.9fr; }
    .controls label { font-size:12px; color:var(--muted); display:block; margin-bottom:4px;}
    .controls input, .controls select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #26304f; background:#0f1530; color:var(--text); }
    .controls-row2 { margin-top:8px; display:grid; gap:8px; grid-template-columns: 1fr auto auto;}
    .btn { padding:10px 14px; border-radius:10px; border:1px solid #2a3963; background:#152044; color:#e8edff; cursor:pointer; }
    .btn:hover { border-color:#39508f; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #2b3a64; color:#a9b7e3; font-size:12px; }
    #results { padding:24px 16px; }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; }
    @media (max-width: 980px) { .grid { grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr;} .controls { grid-template-columns:1fr; } .controls-row2 { grid-template-columns:1fr 1fr; } }
    .card { border:1px solid #223056; background:var(--card); border-radius:16px; padding:16px; display:flex; flex-direction:column; gap:10px; }
    .card h3 { margin:0; font-size:18px; line-height:1.25; }
    .meta { display:flex; flex-wrap:wrap; gap:6px; }
    .muted { color:var(--muted); font-size:13px; }
    .footer { margin-top:auto; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .link { color:var(--accent); text-decoration:none; }
    .count { margin-left:8px; color:var(--muted); font-size:13px; }
    .nores { color:var(--muted); padding:24px 8px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Local Events <span id="count" class="count"></span></h1>
      <div class="controls">
        <div>
          <label for="q">Search</label>
          <input id="q" type="search" placeholder="e.g., job fair, town hall, veterans, small business‚Ä¶" />
        </div>
        <div>
          <label for="start">Start date</label>
          <input id="start" type="date" />
        </div>
        <div>
          <label for="end">End date</label>
          <input id="end" type="date" />
        </div>
        <div>
          <label for="source">Source</label>
          <select id="source">
            <option value="">All sources</option>
          </select>
        </div>
      </div>
      <div class="controls-row2">
        <div>
          <label for="sort">Sort</label>
          <select id="sort">
            <option value="dateAsc">Date (soonest ‚Üí latest)</option>
            <option value="dateDesc">Date (latest ‚Üí oldest)</option>
            <option value="title">Title (A ‚Üí Z)</option>
          </select>
        </div>
        <button id="reset" class="btn">Reset</button>
        <button id="export" class="btn">Export CSV</button>
      </div>
    </div>
  </header>

  <main id="results" class="container">
    <div id="grid" class="grid"></div>
    <div id="empty" class="nores" hidden>No events match your filters.</div>
  </main>

  <script>
    const parseDate = (s) => s ? new Date(s) : null;

    const normalize = (e) => ({
      title: e.title || '(Untitled)',
      start: e.start ? new Date(e.start) : null,
      end: e.end ? new Date(e.end) : null,
      allDay: !!e.allDay,
      location: e.location || '',
      url: e.url || '',
      source: e.source || '',
      description: e.description || ''
    });

    let ALL = [];
    let VIEW = [];

    const els = {
      q: document.getElementById('q'),
      start: document.getElementById('start'),
      end: document.getElementById('end'),
      source: document.getElementById('source'),
      sort: document.getElementById('sort'),
      reset: document.getElementById('reset'),
      export: document.getElementById('export'),
      grid: document.getElementById('grid'),
      empty: document.getElementById('empty'),
      count: document.getElementById('count'),
    };

    function load() {
      fetch('events.json?_=' + Date.now())
        .then(r => r.json())
        .then(data => {
          ALL = data.map(normalize);
          hydrateSourceFilter(ALL);
          apply();
        })
        .catch(err => {
          console.error('Failed to load events.json', err);
          els.grid.innerHTML = '<div class="nores">Could not load events.json. Make sure it is in the same folder as this page.</div>';
        });
    }

    function hydrateSourceFilter(items) {
      const srcs = Array.from(new Set(items.map(e => e.source).filter(Boolean))).sort();
      els.source.innerHTML = '<option value="">All sources</option>' + srcs.map(s => `<option>${s}</option>`).join('');
    }

    function apply() {
      const q = (els.q.value || '').toLowerCase().trim();
      const sd = parseDate(els.start.value);
      const ed = parseDate(els.end.value);
      const src = els.source.value;
      const sort = els.sort.value;

      VIEW = ALL.filter(e => {
        if (q) {
          const hay = [e.title, e.location, e.description, e.source].join(' ').toLowerCase();
          if (!hay.includes(q)) return false;
        }
        if (src && e.source !== src) return false;
        if (sd && e.start && e.start < sd) return false;
        if (ed && e.start && e.start > new Date(ed.getTime() + 24*60*60*1000 - 1)) return false;
        return true;
      });

      if (sort === 'dateAsc') VIEW.sort((a,b) => (a.start || 0) - (b.start || 0));
      if (sort === 'dateDesc') VIEW.sort((a,b) => (b.start || 0) - (a.start || 0));
      if (sort === 'title') VIEW.sort((a,b) => a.title.localeCompare(b.title));

      render(VIEW);
    }

    function render(items) {
      els.grid.innerHTML = items.map(e => {
        const when = e.start
          ? (e.allDay
              ? e.start.toLocaleDateString(undefined, { weekday:'short', year:'numeric', month:'short', day:'numeric' })
              : `${e.start.toLocaleDateString(undefined, { weekday:'short', year:'numeric', month:'short', day:'numeric' })} ${e.start.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' })}${e.end ? ' ‚Äì ' + e.end.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' }) : ''}`
            )
          : '';

        const loc = e.location ? `<span class="pill" title="${e.location}">üìç ${e.location}</span>` : '';
        const src = e.source ? `<span class="pill" title="Source">${e.source}</span>` : '';

        return `
        <article class="card">
          <h3>${escapeHtml(e.title)}</h3>
          ${when ? `<div class="muted">üóì ${when}</div>` : ''}
          <div class="meta">
            ${loc}
            ${src}
          </div>
          ${e.description ? `<div class="muted">${escapeHtml(e.description).slice(0,280)}${e.description.length>280?'‚Ä¶':''}</div>`:''}
          <div class="footer">
            <a class="link" href="${e.url || '#'}" target="_blank" rel="noopener noreferrer">View details ‚Üó</a>
          </div>
        </article>`;
      }).join('');

      const count = items.length;
      els.count.textContent = count ? `‚Äî ${count} event${count!==1?'s':''}` : '';
      els.empty.hidden = count !== 0;
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function resetFilters(){
      els.q.value = '';
      els.start.value = '';
      els.end.value = '';
      els.source.value = '';
      els.sort.value = 'dateAsc';
      apply();
    }

    function exportCSV(){
      const header = ['title','start','end','allDay','location','url','source','description'];
      const rows = [header].concat(VIEW.map(e => header.map(k => {
        const v = e[k];
        const cell = (v instanceof Date) ? v.toISOString() : (v ?? '');
        return `"${String(cell).replace(/"/g,'""')}"`;
      }).join(',')));
      const blob = new Blob([rows.join('\n')], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'events_export.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    ['input','change'].forEach(ev => els.q.addEventListener(ev, apply));
    ['change'].forEach(ev => {
      els.start.addEventListener(ev, apply);
      els.end.addEventListener(ev, apply);
      els.source.addEventListener(ev, apply);
      els.sort.addEventListener(ev, apply);
    });
    els.reset.addEventListener('click', resetFilters);
    els.export.addEventListener('click', exportCSV);

    load();
  </script>
</body>
</html>

